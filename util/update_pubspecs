#!/bin/bash

if [ ! -f util/.serverpod_util_root ]; then
    echo "Run this script from the root of the Serverpod repository"
    echo "I.e. util/update_pubspecs"
    exit 1
fi

# Makes script exit on first non-zero error code
set -e

# Source the package lists from all_packages
source util/all_packages

VERSION=`cat SERVERPOD_VERSION`
DART_VERSION=`cat DART_VERSION`
FLUTTER_VERSION=`cat FLUTTER_VERSION`

BASE=`pwd`
CLI_DIR=$BASE/tools/serverpod_cli
CLI=$CLI_DIR/bin/serverpod_cli.dart

echo "pub get cli"
cd $CLI_DIR
dart pub get
cd $BASE

echo "Sort all pubspecs dependencies"
pubspecs=$(find . -name "pubspec.yaml" -type f)
echo "$pubspecs" | xargs -P $(util/get_max_cores) -I {} bash -c 'dart run sort_pubspec_dependencies --pubspec-path="{}" > /dev/null'

echo "Update all pubspecs. Version is $VERSION (Dart version: $DART_VERSION, Flutter version: $FLUTTER_VERSION)."

dart $CLI generate-pubspecs --version "$VERSION" --dart-version "$DART_VERSION" --flutter-version "$FLUTTER_VERSION" --mode development

echo "Copying CHANGELOG.md"
# Copy to all Flutter packages
for package in "${FLUTTER_PACKAGES_PATHS[@]}"; do
    cp CHANGELOG.md "$package/CHANGELOG.md"
done

# Copy to all Dart packages
for package in "${DART_PACKAGES_PATHS[@]}"; do
    cp CHANGELOG.md "$package/CHANGELOG.md"
done

# Additional packages not in the arrays
cp CHANGELOG.md packages/serverpod_lints/CHANGELOG.md
cp CHANGELOG.md templates/serverpod_templates/CHANGELOG.md

echo "Copying README.md"
# Special case: packages/serverpod gets README.md
cp README.md packages/serverpod/README.md

# Copy README_subpackage.md to all Flutter packages
for package in "${FLUTTER_PACKAGES_PATHS[@]}"; do
    cp README_subpackage.md "$package/README.md"
done

# Copy README_subpackage.md to all Dart packages (except serverpod which already got README.md)
for package in "${DART_PACKAGES_PATHS[@]}"; do
    if [ "$package" != "packages/serverpod" ]; then
        cp README_subpackage.md "$package/README.md"
    fi
done

# Additional packages not in the arrays
cp README_subpackage.md packages/serverpod_lints/README.md
cp README_subpackage.md templates/serverpod_templates/README.md

# Note: Some packages are intentionally commented out in the original:
# - modules/serverpod_auth/serverpod_auth_bridge/* (client, flutter, server)
# - modules/serverpod_auth/serverpod_auth_migration/* (client, server)
# These are included in the arrays but may need special handling if needed
